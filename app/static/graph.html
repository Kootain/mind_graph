<html>
 <head>
  <meta charset="utf-8" />
  <script src="lib/bindings/utils.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.2/dist/dist/vis-network.min.css" integrity="sha512-WgxfT5LWjfszlPHXRmBWHkV2eceiWTOBvrKCNbdgDYTHrT2AeLCGbF4sZlZw3UMN3WtL0tGUoIAKsu8mllg/XA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.2/dist/vis-network.min.js" integrity="sha512-LnvoEWDFrqGHlHmDD2101OrLcbsfkrzoSpvtSQtxK3RMnRV0eOkhhBN2dXHKRrUU8p2DGRTk35n4O8nWSVe1mQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
 </head>
 <body>
  <center>
   <h1></h1>
  </center>
  <!-- <link rel="stylesheet" href="../node_modules/vis/dist/vis.min.css" type="text/css" />
<script type="text/javascript" src="../node_modules/vis/dist/vis.js"> </script>-->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js" integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf" crossorigin="anonymous"></script>
  <center>
   <h1></h1>
  </center>
  <style type="text/css">

             #mynetwork {
                 width: 100%;
                 height: 600px;
                 background-color: #ffffff;
                 border: 1px solid lightgray;
                 position: relative;
                 float: left;
             }

        </style>
  <div class="card" style="width: 100%">
   <div id="mynetwork" class="card-body"></div>
  </div>
  <script type="text/javascript">
  // 初始化图表
  var container = document.getElementById('mynetwork');
  var data = {
    nodes: new vis.DataSet(),
    edges: new vis.DataSet()
  };
  var options = {"physics": {"forceAtlas2Based": {"gravitationalConstant": -50, "centralGravity": 0.005, "springLength": 100, "springConstant": 0.08}, "maxVelocity": 50, "minVelocity": 0.1, "solver": "forceAtlas2Based", "timestep": 0.35, "stabilization": {"enabled": true, "iterations": 1000}}};
  var network = new vis.Network(container, data, options);
function calculateDiff(dataSetA, dataSetB) {
    // 获取两个 DataSet 的 id 数组
    var idsA = dataSetA.getIds();
    var idsB = dataSetB.getIds();

    // 计算 dataSetA 中有而 dataSetB 中没有的元素（A - B）
    var inAnotB = idsA.filter(function(id) {
        return idsB.indexOf(id) === -1;
    });

    // 计算 dataSetB 中有而 dataSetA 中没有的元素（B - A）
    var inBnotA = idsB.filter(function(id) {
        return idsA.indexOf(id) === -1;
    });

    // 获取实际的元素对象
    var itemsInAnotB = inAnotB.map(function(id) {
        return dataSetA.get(id);
    });

    var itemsInBnotA = inBnotA.map(function(id) {
        return dataSetB.get(id);
    });

    // 返回结果
    return {
        added: itemsInBnotA,   // 在 B 中新添加的元素
        removed: itemsInAnotB  // 从 A 中移除的元素
    };
}
function calculateEdgesDiff(edgesA, edgesB) {
    var diff = {
        added: [],
        removed: []
    };

    var itemsA = edgesA.get();
    var itemsB = edgesB.get();

    // 创建一个边的字符串表示来比较
    var stringifyEdge = function(edge) {
        return edge.from + '-' + edge.to;
    };

    var edgeStringsA = itemsA.map(stringifyEdge);
    var edgeStringsB = itemsB.map(stringifyEdge);

    // 找出 A 中有但 B 中没有的边
    diff.removed = itemsA.filter(function(edge) {
        return edgeStringsB.indexOf(stringifyEdge(edge)) === -1;
    });

    // 找出 B 中有但 A 中没有的边
    diff.added = itemsB.filter(function(edge) {
        return edgeStringsA.indexOf(stringifyEdge(edge)) === -1;
    });

    return diff;
}
  // 从API获取数据并更新图表
  function fetchDataAndUpdateGraph(keyword) {
    var apiUrl = '/api/graph?keyword='+keyword; // 用您的API地址替换这里的URL
    fetch(apiUrl)
      .then(response => response.json())
      .then(res => {
        var newNodes = new vis.DataSet(res.nodes)
        var newEdge = new vis.DataSet(res.edges)
        diff = calculateDiff(data.nodes, newNodes)
        diff.added.forEach(e=>{
          data.nodes.add(e)
        })

        diff = calculateEdgesDiff(data.edges, newEdge)
        diff.added.forEach(e=>{
          data.edges.add(e)
        })

      })
      .catch(error => {
            // 添加新数据
          network.setData(data);
          console.error('Error fetching data:', error)
      });
  }

  // 节点点击事件监听器
  network.on('click', function (params) {
    if (params.nodes.length > 0) {
        var nodeId = params.nodes[0];
        fetchDataAndUpdateGraph(nodeId)
    }
  });

  document.addEventListener('DOMContentLoaded', function() {
    // 解析当前页面URL
    var urlParams = new URLSearchParams(window.location.search);
    // 获取 'keyword' 查询参数
    var keyword = urlParams.get('keyword');
    // 如果存在 'keyword' 参数，则使用它调用 fetchDataAndUpdateGraph 函数
    if (keyword) {
      fetchDataAndUpdateGraph(keyword);
    } else {
      // 如果没有 'keyword' 参数，可以选择一个默认值或者不做任何操作
      console.log('Keyword query parameter is not provided.');
    }
  });

  // 初始加载数据
  // fetchDataAndUpdateGraph('光伏作用');
</script>
 </body>
</html>